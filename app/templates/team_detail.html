{% extends "base.html" %}
{% block title %}Dettaglio squadra — Calcio Analytics{% endblock %}
{% block main_class %}teams-page{% endblock %}
{% block extra_css %}
<style>
  .detail-card {
    background: #22222e;
    border-radius: 20px;
    padding: 32px;
    width: 100%;
    max-width: 960px;
    margin: 0 auto;
    box-shadow: 0 20px 50px rgba(0,0,0,0.4);
    animation: fadeIn 0.4s ease;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .detail-card h1 { margin: 0 0 8px 0; font-size: 1.5rem; font-weight: 600; }
  .detail-card .sub { color: #888; font-size: 0.9rem; margin-bottom: 24px; }
  .detail-card .back-link { color: #6ee7a0; text-decoration: none; font-size: 0.9rem; margin-bottom: 16px; display: inline-block; }
  .detail-card .back-link:hover { text-decoration: underline; }
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 28px;
  }
  @media (max-width: 720px) { .stats-grid { grid-template-columns: 1fr; } }
  .stat-box {
    background: #1e1e28;
    border-radius: 16px;
    padding: 20px;
    border: 1px solid #2a2a36;
  }
  .stat-box h3 { margin: 0 0 14px 0; font-size: 0.95rem; color: #aaa; font-weight: 600; }
  .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
  .stat-row .label { color: #888; }
  .form-section { margin-bottom: 28px; }
  .form-section h3 { margin: 0 0 12px 0; font-size: 1rem; color: #aaa; font-weight: 600; }
  .form-badges { display: flex; gap: 10px; flex-wrap: wrap; }
  .form-badge {
    width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 1rem; color: #1a1a24;
  }
  .form-badge.W { background: #4a7c59; color: #e2e2e8; }
  .form-badge.D { background: #e7c66e; color: #1a1a24; }
  .form-badge.L { background: #c55; color: #e2e2e8; }
  .players-section h3 { margin: 0 0 12px 0; font-size: 1rem; color: #aaa; font-weight: 600; }
  .players-toolbar { margin-bottom: 12px; }
  .players-toolbar .search-input {
    padding: 10px 14px; font-size: 0.95rem; border-radius: 12px; border: 1px solid #3d3d55;
    background: #1e1e28; color: #e2e2e8; min-width: 220px;
  }
  .players-toolbar .search-input:focus { outline: none; border-color: #4a7c59; }
  .players-table-wrap { overflow-x: auto; border-radius: 12px; border: 1px solid #2a2a36; margin-bottom: 24px; }
  .players-table {
    width: 100%; border-collapse: collapse; font-size: 0.9rem;
  }
  .players-table th, .players-table td { padding: 12px 14px; text-align: left; border-bottom: 1px solid #2a2a36; }
  .players-table th { background: #1e1e28; color: #aaa; font-weight: 600; white-space: nowrap; }
  .players-table th.numeric { text-align: right; }
  .players-table th.sortable { cursor: pointer; user-select: none; }
  .players-table th.sortable:hover { color: #e2e2e8; }
  .players-table th.sorted-asc::after { content: ' ▲'; opacity: 0.8; }
  .players-table th.sorted-desc::after { content: ' ▼'; opacity: 0.8; }
  .players-table td { color: #e2e2e8; }
  .players-table td.numeric { text-align: right; font-variant-numeric: tabular-nums; }
  .players-table tbody tr.clickable { cursor: pointer; transition: background 0.15s; }
  .players-table tbody tr.clickable:hover { background: #2a2a36; }
  .detail-loading { display: flex; align-items: center; gap: 12px; padding: 40px; color: #888; }
  .detail-loading .spinner {
    width: 28px; height: 28px; border: 3px solid #2a2a36; border-top-color: #6ee7a0;
    border-radius: 50%; animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .detail-error {
    padding: 20px; border-radius: 12px; background: #2a2020; border-left: 4px solid #c55;
    color: #f08a8a; margin-top: 16px; display: none;
  }
  .detail-error.visible { display: block; }
  .detail-content { display: none; }
  .detail-content.visible { display: block; animation: fadeIn 0.3s ease; }
  .players-empty { padding: 24px; text-align: center; color: #888; font-size: 0.95rem; }
  .btn-load-roster {
    display: inline-flex; align-items: center; gap: 8px;
    margin-top: 12px; padding: 10px 22px; border: none; border-radius: 12px;
    background: #4a7c59; color: #e2e2e8; font-size: 0.9rem; font-weight: 600;
    cursor: pointer; transition: background 0.2s, transform 0.1s;
  }
  .btn-load-roster:hover { background: #5a9a6a; transform: translateY(-1px); }
  .btn-load-roster:active { transform: translateY(0); }
  .btn-load-roster:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
  .btn-load-roster .spinner-sm {
    width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff;
    border-radius: 50%; animation: spin 0.7s linear infinite; display: none;
  }
  .btn-load-roster.loading .spinner-sm { display: inline-block; }
  .ingest-result {
    margin-top: 10px; padding: 10px 16px; border-radius: 10px; font-size: 0.85rem; display: none;
  }
  .ingest-result.success { display: block; background: #1e3a28; color: #6ee7a0; border: 1px solid #4a7c59; }
  .ingest-result.error { display: block; background: #3a1e1e; color: #f08a8a; border: 1px solid #c55; }
  .season-select-wrap { margin-bottom: 16px; }
  .season-select-wrap label { display: block; color: #888; font-size: 0.85rem; margin-bottom: 6px; }
  .season-select-wrap select {
    padding: 8px 12px; border-radius: 10px; border: 1px solid #3d3d55; background: #1e1e28; color: #e2e2e8;
    font-size: 0.9rem; cursor: pointer;
  }
</style>
{% endblock %}

{% block content %}
<div class="detail-card">
  <a href="/teams" class="back-link">← Torna a Squadre</a>
  <div class="season-select-wrap">
    <label for="seasonSelect">Stagione</label>
    <select id="seasonSelect" aria-label="Stagione">
      <option value="2024">2024/2025</option>
    </select>
  </div>
  <h1 id="teamName">—</h1>
  <p class="sub" id="teamSub">Caricamento…</p>

  <div id="detailError" class="detail-error"></div>
  <div id="detailLoading" class="detail-loading">
    <div class="spinner"></div>
    <span>Caricamento dettaglio…</span>
  </div>

  <div id="detailContent" class="detail-content">
    <div class="stats-grid">
      <div class="stat-box">
        <h3>Stagione</h3>
        <div id="seasonStats"></div>
      </div>
      <div class="stat-box">
        <h3>Casa</h3>
        <div id="homeStats"></div>
      </div>
      <div class="stat-box">
        <h3>Trasferta</h3>
        <div id="awayStats"></div>
      </div>
    </div>

    <div class="form-section">
      <h3>Form ultime 5</h3>
      <div id="formBadges" class="form-badges"></div>
    </div>

    <div class="players-section">
      <h3>Rosa</h3>
      <div class="players-toolbar">
        <input type="text" id="playerSearch" class="search-input" placeholder="Cerca giocatore…" aria-label="Cerca giocatore">
      </div>
      <div id="playersLoading" class="detail-loading" style="display: none; padding: 24px;">
        <div class="spinner"></div>
        <span>Caricamento rosa…</span>
      </div>
      <div id="playersEmpty" class="players-empty" style="display: none;">
        Nessun giocatore in rosa per questa stagione.
        <br>
        <button id="btnLoadRoster" class="btn-load-roster" type="button">
          <span class="spinner-sm"></span>
          Carica rosa
        </button>
        <div id="ingestResult" class="ingest-result"></div>
      </div>
      <div id="playersTableWrap" class="players-table-wrap" style="display: none;">
        <table class="players-table" aria-label="Rosa giocatori">
          <thead>
            <tr>
              <th class="sortable" data-sort="name">Nome</th>
              <th class="sortable" data-sort="position">Pos</th>
              <th class="sortable numeric" data-sort="minutes">Min</th>
              <th class="sortable numeric" data-sort="goals">G</th>
              <th class="sortable numeric" data-sort="assists">A</th>
              <th class="sortable numeric" data-sort="shots">Tiri</th>
              <th class="sortable numeric" data-sort="pass_accuracy">Prec. pass.</th>
              <th class="sortable numeric" data-sort="rating">Voto</th>
            </tr>
          </thead>
          <tbody id="playersBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  window.TEAM_DETAIL_INIT = { team_id: {{ team_id }}, season: {{ season }} };
</script>
{% endblock %}

{% block page_js %}
<script>
(function() {
  const cfg = window.TEAM_DETAIL_INIT || { team_id: 0, season: 2024 };
  const teamId = cfg.team_id;
  const initialSeason = cfg.season;

  const teamNameEl = document.getElementById('teamName');
  const teamSubEl = document.getElementById('teamSub');
  const seasonSelect = document.getElementById('seasonSelect');
  const detailError = document.getElementById('detailError');
  const detailLoading = document.getElementById('detailLoading');
  const detailContent = document.getElementById('detailContent');
  const seasonStatsEl = document.getElementById('seasonStats');
  const homeStatsEl = document.getElementById('homeStats');
  const awayStatsEl = document.getElementById('awayStats');
  const formBadgesEl = document.getElementById('formBadges');
  const playerSearch = document.getElementById('playerSearch');
  const playersLoading = document.getElementById('playersLoading');
  const playersEmpty = document.getElementById('playersEmpty');
  const playersTableWrap = document.getElementById('playersTableWrap');
  const playersBody = document.getElementById('playersBody');
  const btnLoadRoster = document.getElementById('btnLoadRoster');
  const ingestResult = document.getElementById('ingestResult');

  let detailData = null;
  let allPlayers = [];
  let sortKey = 'name';
  let sortDir = 'asc';

  function setError(msg) {
    detailError.textContent = msg || '';
    detailError.classList.toggle('visible', !!msg);
  }
  function renderStatRows(stats) {
    if (!stats) return '';
    return '<div class="stat-row"><span class="label">G</span><span>' + (stats.played ?? '—') + '</span></div>' +
      '<div class="stat-row"><span class="label">V-N-S</span><span>' + (stats.wins ?? '—') + '-' + (stats.draws ?? '—') + '-' + (stats.losses ?? '—') + '</span></div>' +
      '<div class="stat-row"><span class="label">GF / GS</span><span>' + (stats.goals_for ?? '—') + ' / ' + (stats.goals_against ?? '—') + '</span></div>' +
      '<div class="stat-row"><span class="label">DR</span><span>' + (stats.goal_diff ?? '—') + '</span></div>' +
      '<div class="stat-row"><span class="label">Pt</span><span>' + (stats.points ?? '—') + '</span></div>' +
      '<div class="stat-row"><span class="label">Media GF</span><span>' + (stats.avg_goals_for != null ? Number(stats.avg_goals_for).toFixed(2) : '—') + '</span></div>' +
      '<div class="stat-row"><span class="label">Media GS</span><span>' + (stats.avg_goals_against != null ? Number(stats.avg_goals_against).toFixed(2) : '—') + '</span></div>';
  }
  var resultLabelMap = { 'W': 'V', 'D': 'N', 'L': 'S' };
  function renderForm(formLast5) {
    if (!formLast5 || formLast5.length === 0) return '<span style="color:#888;">Nessuna partita</span>';
    return formLast5.map(function(m) {
      var r = m.result || 'D';
      var label = resultLabelMap[r] || r;
      return '<span class="form-badge ' + r + '" title="' + (m.goals_for ?? 0) + '-' + (m.goals_against ?? 0) + '">' + label + '</span>';
    }).join('');
  }
  function escapeHtml(s) {
    if (s == null) return '';
    var div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }
  function getSearchTerm() {
    return (playerSearch.value || '').trim().toLowerCase();
  }
  function filteredAndSortedPlayers() {
    var q = getSearchTerm();
    var list = q ? allPlayers.filter(function(p) { return (p.name || '').toLowerCase().indexOf(q) >= 0; }) : allPlayers.slice();
    list.sort(function(a, b) {
      var va = a[sortKey], vb = b[sortKey];
      if (typeof va === 'string') { va = (va || '').toLowerCase(); vb = (vb || '').toLowerCase(); }
      if (va < vb) return sortDir === 'asc' ? -1 : 1;
      if (va > vb) return sortDir === 'asc' ? 1 : -1;
      return 0;
    });
    return list;
  }
  function renderPlayersTable() {
    var rows = filteredAndSortedPlayers();
    playersBody.innerHTML = '';
    rows.forEach(function(p) {
      var tr = document.createElement('tr');
      tr.className = 'clickable';
      tr.setAttribute('data-player-id', p.player_id);
      tr.innerHTML = '<td>' + escapeHtml(p.name || '—') + '</td>' +
        '<td>' + escapeHtml(p.position || '—') + '</td>' +
        '<td class="numeric">' + (p.minutes ?? '—') + '</td>' +
        '<td class="numeric">' + (p.goals ?? '—') + '</td>' +
        '<td class="numeric">' + (p.assists ?? '—') + '</td>' +
        '<td class="numeric">' + (p.shots ?? '—') + '</td>' +
        '<td class="numeric">' + (p.pass_accuracy != null ? Number(p.pass_accuracy).toFixed(1) + '%' : '—') + '</td>' +
        '<td class="numeric">' + (p.rating != null ? Number(p.rating).toFixed(2) : '—') + '</td>';
      playersBody.appendChild(tr);
    });
    document.querySelectorAll('.players-table th.sortable').forEach(function(th) {
      th.classList.remove('sorted-asc', 'sorted-desc');
      if (th.getAttribute('data-sort') === sortKey) th.classList.add(sortDir === 'asc' ? 'sorted-asc' : 'sorted-desc');
    });
  }

  function loadDetail(season) {
    setError('');
    detailLoading.style.display = 'flex';
    detailContent.classList.remove('visible');
    fetch('/api/teams/' + teamId + '/season/' + season + '/detail')
      .then(function(r) {
        if (!r.ok) throw new Error(r.status === 404 ? 'Squadra non trovata' : 'Errore ' + r.status);
        return r.json();
      })
      .then(function(data) {
        detailData = data;
        detailLoading.style.display = 'none';
        detailContent.classList.add('visible');
        teamNameEl.textContent = (data.team && data.team.team_name) ? data.team.team_name : '—';
        teamSubEl.textContent = 'Stagione ' + season;
        seasonStatsEl.innerHTML = renderStatRows(data.season_stats);
        homeStatsEl.innerHTML = renderStatRows(data.home_stats);
        awayStatsEl.innerHTML = renderStatRows(data.away_stats);
        formBadgesEl.innerHTML = renderForm(data.form_last5);
        loadPlayers(season);
      })
      .catch(function(e) {
        detailLoading.style.display = 'none';
        setError(e.message || 'Errore di rete.');
      });
  }
  function loadPlayers(season) {
    playersLoading.style.display = 'flex';
    playersEmpty.style.display = 'none';
    playersTableWrap.style.display = 'none';
    fetch('/api/teams/' + teamId + '/season/' + season + '/players')
      .then(function(r) { return r.ok ? r.json() : []; })
      .then(function(list) {
        allPlayers = list || [];
        playersLoading.style.display = 'none';
        if (allPlayers.length === 0) {
          playersEmpty.style.display = 'block';
        } else {
          playersTableWrap.style.display = 'block';
          renderPlayersTable();
        }
      })
      .catch(function() {
        playersLoading.style.display = 'none';
        playersEmpty.style.display = 'block';
      });
  }

  seasonSelect.addEventListener('change', function() {
    var s = parseInt(seasonSelect.value, 10);
    if (!isNaN(s)) window.location.href = '/teams/' + teamId + '?season=' + s;
  });
  playerSearch.addEventListener('input', function() { if (allPlayers.length) renderPlayersTable(); });
  document.querySelectorAll('.players-table th.sortable').forEach(function(th) {
    th.addEventListener('click', function() {
      var key = th.getAttribute('data-sort');
      if (key === sortKey) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
      else { sortKey = key; sortDir = key === 'name' ? 'asc' : 'desc'; }
      renderPlayersTable();
    });
  });
  playersBody.addEventListener('click', function(e) {
    var tr = e.target.closest('tr.clickable');
    if (!tr) return;
    var playerId = tr.getAttribute('data-player-id');
    if (playerId) console.log('Player click (dettaglio futuro):', playerId);
  });

  function getCurrentSeason() {
    return parseInt(seasonSelect.value, 10) || initialSeason;
  }

  function ingestPlayers() {
    var season = getCurrentSeason();
    btnLoadRoster.disabled = true;
    btnLoadRoster.classList.add('loading');
    ingestResult.className = 'ingest-result';
    ingestResult.style.display = 'none';

    fetch('/api/teams/' + teamId + '/season/' + season + '/ingest-players', { method: 'POST' })
      .then(function(r) {
        if (!r.ok) return r.json().then(function(err) { throw new Error(err.detail || 'Errore ' + r.status); });
        return r.json();
      })
      .then(function(data) {
        btnLoadRoster.disabled = false;
        btnLoadRoster.classList.remove('loading');
        ingestResult.className = 'ingest-result success';
        ingestResult.textContent = 'Caricati ' + data.players_ingested + ' giocatori.';
        if (data.players_ingested > 0) {
          setTimeout(function() { loadPlayers(season); }, 600);
        }
      })
      .catch(function(e) {
        btnLoadRoster.disabled = false;
        btnLoadRoster.classList.remove('loading');
        ingestResult.className = 'ingest-result error';
        ingestResult.textContent = 'Errore: ' + (e.message || 'Errore di rete.');
      });
  }

  btnLoadRoster.addEventListener('click', ingestPlayers);

  (function init() {
    fetch('/leagues/seasons').then(function(r) { return r.ok ? r.json() : null; }).then(function(data) {
      var seasons = (data && data.seasons) ? data.seasons : [2024];
      seasonSelect.innerHTML = '';
      seasons.forEach(function(y) {
        var opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y === 2024 ? '2024/2025' : String(y);
        opt.selected = (y === initialSeason);
        seasonSelect.appendChild(opt);
      });
    }).catch(function() {
      seasonSelect.innerHTML = '<option value="2024">2024/2025</option>';
      if (initialSeason !== 2024) seasonSelect.innerHTML = '<option value="' + initialSeason + '">' + initialSeason + '</option>' + seasonSelect.innerHTML;
    });
    loadDetail(initialSeason);
  })();
})();
</script>
{% endblock %}
