{% extends "base.html" %}
{% block title %}Dettaglio squadra — Calcio Analytics{% endblock %}
{% block main_class %}teams-page{% endblock %}
{% block extra_css %}
<style>
  main.teams-page { max-width: 100%; padding: 16px 10px; }

  .detail-card {
    background: #22222e;
    border-radius: 16px;
    padding: 20px 14px;
    width: 100%;
    box-shadow: 0 20px 50px rgba(0,0,0,0.4);
    animation: fadeIn 0.4s ease;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .detail-card h1 { margin: 0 0 6px 0; font-size: 1.4rem; font-weight: 600; }
  .detail-card .sub { color: #888; font-size: 0.85rem; margin-bottom: 20px; }
  .detail-card .back-link { color: #6ee7a0; text-decoration: none; font-size: 0.85rem; margin-bottom: 12px; display: inline-block; }
  .detail-card .back-link:hover { text-decoration: underline; }
  .stats-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-bottom: 22px;
  }
  @media (max-width: 720px) { .stats-grid { grid-template-columns: 1fr; } }
  .stat-box {
    background: #1e1e28; border-radius: 12px; padding: 16px; border: 1px solid #2a2a36;
  }
  .stat-box h3 { margin: 0 0 10px 0; font-size: 0.9rem; color: #aaa; font-weight: 600; }
  .stat-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.85rem; }
  .stat-row .label { color: #888; }
  .form-section { margin-bottom: 22px; }
  .form-section h3 { margin: 0 0 10px 0; font-size: 0.95rem; color: #aaa; font-weight: 600; }
  .form-badges { display: flex; gap: 8px; flex-wrap: wrap; }
  .form-badge {
    width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 0.9rem;
  }
  .form-badge.W { background: #4a7c59; color: #e2e2e8; }
  .form-badge.D { background: #e7c66e; color: #1a1a24; }
  .form-badge.L { background: #c55; color: #e2e2e8; }
  .players-section h3 { margin: 0 0 10px 0; font-size: 0.95rem; color: #aaa; font-weight: 600; }
  .players-toolbar { margin-bottom: 10px; }
  .players-toolbar .search-input {
    padding: 8px 12px; font-size: 0.85rem; border-radius: 10px; border: 1px solid #3d3d55;
    background: #1e1e28; color: #e2e2e8; min-width: 200px;
  }
  .players-toolbar .search-input:focus { outline: none; border-color: #4a7c59; }

  /* --- Badge ruolo --- */
  .role-header {
    display: flex; align-items: center; gap: 8px;
    margin: 18px 0 6px 0;
  }
  .role-header:first-child { margin-top: 0; }
  .role-badge {
    display: inline-block; padding: 3px 10px; border-radius: 6px;
    font-size: 0.78rem; font-weight: 700; letter-spacing: 0.03em; text-transform: uppercase;
  }
  .role-badge.gk  { background: #2a3f5f; color: #6eb4f7; }
  .role-badge.def { background: #1e3a28; color: #6ee7a0; }
  .role-badge.mid { background: #352a4a; color: #b68af7; }
  .role-badge.att { background: #4a2020; color: #f28a8a; }
  .role-count { font-size: 0.75rem; color: #666; }
  .role-disclaimer {
    font-size: 0.7rem; color: #666; margin: 0 0 6px 2px;
    font-style: italic; letter-spacing: 0.01em;
  }

  /* --- Tabella compatta --- */
  .players-table-wrap {
    overflow-x: hidden; border-radius: 10px; border: 1px solid #2a2a36; margin-bottom: 14px;
  }
  .players-table {
    width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 0.74rem;
  }
  .players-table th,
  .players-table td {
    padding: 4px 3px; text-align: center; border-bottom: 1px solid #2a2a36;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .players-table th {
    background: #1e1e28; color: #888; font-weight: 600; font-size: 0.68rem;
    text-transform: uppercase; letter-spacing: 0.02em;
  }
  .players-table th.sortable { cursor: pointer; user-select: none; }
  .players-table th.sortable:hover { color: #e2e2e8; }
  .players-table th.sorted-asc::after  { content: '▲'; font-size: 0.55rem; margin-left: 1px; opacity: 0.8; }
  .players-table th.sorted-desc::after { content: '▼'; font-size: 0.55rem; margin-left: 1px; opacity: 0.8; }
  .players-table td { color: #d0d0d8; }
  .players-table td.col-name { text-align: left; font-weight: 500; color: #e2e2e8; }
  .players-table th.col-name-h { text-align: left; }
  .players-table tbody tr.clickable { cursor: pointer; transition: background 0.15s; }
  .players-table tbody tr.clickable:hover { background: #2a2a36; }
  .player-id-link { color: #6a6a7a; font-size: 0.68rem; font-family: monospace; text-decoration: none; }
  .player-id-link:hover { color: #6ee7a0; text-decoration: underline; }

  .sc-h { color: #6ee7a0; font-weight: 700; }
  .sc-m { color: #e7c66e; font-weight: 700; }
  .sc-l { color: #f08a8a; font-weight: 600; }
  .sc-n { color: #555; }
  .v90  { color: #8a8aaa; }

  .detail-loading { display: flex; align-items: center; gap: 12px; padding: 40px; color: #888; }
  .detail-loading .spinner {
    width: 28px; height: 28px; border: 3px solid #2a2a36; border-top-color: #6ee7a0;
    border-radius: 50%; animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .detail-error {
    padding: 16px; border-radius: 10px; background: #2a2020; border-left: 4px solid #c55;
    color: #f08a8a; margin-top: 12px; display: none;
  }
  .detail-error.visible { display: block; }
  .detail-content { display: none; }
  .detail-content.visible { display: block; animation: fadeIn 0.3s ease; }
  .players-empty { padding: 20px; text-align: center; color: #888; font-size: 0.9rem; }
  .btn-load-roster {
    display: inline-flex; align-items: center; gap: 8px;
    margin-top: 10px; padding: 8px 18px; border: none; border-radius: 10px;
    background: #4a7c59; color: #e2e2e8; font-size: 0.85rem; font-weight: 600;
    cursor: pointer; transition: background 0.2s, transform 0.1s;
  }
  .btn-load-roster:hover { background: #5a9a6a; transform: translateY(-1px); }
  .btn-load-roster:active { transform: translateY(0); }
  .btn-load-roster:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
  .btn-load-roster .spinner-sm {
    width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff;
    border-radius: 50%; animation: spin 0.7s linear infinite; display: none;
  }
  .btn-load-roster.loading .spinner-sm { display: inline-block; }
  .ingest-result {
    margin-top: 8px; padding: 8px 14px; border-radius: 8px; font-size: 0.82rem; display: none;
  }
  .ingest-result.success { display: block; background: #1e3a28; color: #6ee7a0; border: 1px solid #4a7c59; }
  .ingest-result.error   { display: block; background: #3a1e1e; color: #f08a8a; border: 1px solid #c55; }
  .season-select-wrap { margin-bottom: 14px; }
  .season-select-wrap label { display: block; color: #888; font-size: 0.82rem; margin-bottom: 4px; }
  .season-select-wrap select {
    padding: 6px 10px; border-radius: 8px; border: 1px solid #3d3d55; background: #1e1e28; color: #e2e2e8;
    font-size: 0.85rem; cursor: pointer;
  }
</style>
{% endblock %}

{% block content %}
<div class="detail-card">
  <a href="/teams" class="back-link">← Torna a Squadre</a>
  <div class="season-select-wrap">
    <label for="seasonSelect">Stagione</label>
    <select id="seasonSelect" aria-label="Stagione">
      <option value="2024">2024/2025</option>
    </select>
  </div>
  <h1 id="teamName">—</h1>
  <p class="sub" id="teamSub">Caricamento…</p>

  <div id="detailError" class="detail-error"></div>
  <div id="detailLoading" class="detail-loading">
    <div class="spinner"></div>
    <span>Caricamento dettaglio…</span>
  </div>

  <div id="detailContent" class="detail-content">
    <div class="stats-grid">
      <div class="stat-box"><h3>Stagione</h3><div id="seasonStats"></div></div>
      <div class="stat-box"><h3>Casa</h3><div id="homeStats"></div></div>
      <div class="stat-box"><h3>Trasferta</h3><div id="awayStats"></div></div>
    </div>

    <div class="form-section">
      <h3>Form ultime 5</h3>
      <div id="formBadges" class="form-badges"></div>
    </div>

    <div class="players-section">
      <h3>Rosa</h3>
      <div class="players-toolbar">
        <input type="text" id="playerSearch" class="search-input" placeholder="Cerca giocatore…" aria-label="Cerca giocatore">
      </div>
      <div id="playersLoading" class="detail-loading" style="display: none; padding: 20px;">
        <div class="spinner"></div>
        <span>Caricamento rosa…</span>
      </div>
      <div id="playersEmpty" class="players-empty" style="display: none;">
        Nessun giocatore in rosa per questa stagione.
        <br>
        <button id="btnLoadRoster" class="btn-load-roster" type="button">
          <span class="spinner-sm"></span>
          Carica rosa
        </button>
        <div id="ingestResult" class="ingest-result"></div>
      </div>
      <div id="playersGroups" style="display: none;"></div>
    </div>
  </div>
</div>

<script>
  window.TEAM_DETAIL_INIT = { team_id: {{ team_id }}, season: {{ season }} };
</script>
{% endblock %}

{% block page_js %}
<script>
(function() {
  var cfg = window.TEAM_DETAIL_INIT || { team_id: 0, season: 2024 };
  var teamId = cfg.team_id;
  var initialSeason = cfg.season;

  var teamNameEl = document.getElementById('teamName');
  var teamSubEl = document.getElementById('teamSub');
  var seasonSelect = document.getElementById('seasonSelect');
  var detailError = document.getElementById('detailError');
  var detailLoading = document.getElementById('detailLoading');
  var detailContent = document.getElementById('detailContent');
  var seasonStatsEl = document.getElementById('seasonStats');
  var homeStatsEl = document.getElementById('homeStats');
  var awayStatsEl = document.getElementById('awayStats');
  var formBadgesEl = document.getElementById('formBadges');
  var playerSearch = document.getElementById('playerSearch');
  var playersLoading = document.getElementById('playersLoading');
  var playersEmpty = document.getElementById('playersEmpty');
  var playersGroups = document.getElementById('playersGroups');
  var btnLoadRoster = document.getElementById('btnLoadRoster');
  var ingestResult = document.getElementById('ingestResult');

  var allPlayers = [];
  var sortStates = {};

  /* ---------- Configurazione gruppi ruolo ---------- */

  var ROLE_GROUPS = [
    { key: 'Goalkeeper',  label: 'Portieri',       css: 'gk'  },
    { key: 'Defender',    label: 'Difensori',      css: 'def' },
    { key: 'Midfielder',  label: 'Centrocampisti', css: 'mid' },
    { key: 'Attacker',    label: 'Attaccanti',     css: 'att' }
  ];

  /* ---------- Catalogo colonne (ogni colonna definita una sola volta) ---------- */

  var ALL_COLS = {
    api_player_id:      { label: 'ID',   title: 'API Player ID',           width: '4%'  },
    name:               { label: 'Nome', title: 'Nome giocatore',          width: '14%', cls: 'col-name-h', cellCls: 'col-name' },
    overall_score:      { label: 'Sc',   title: 'Punteggio complessivo',   width: '5%'  },
    appearances:        { label: 'Pr',   title: 'Presenze',                width: '4%'  },
    minutes:            { label: 'Min',  title: 'Minuti giocati',          width: '5%'  },
    goals:              { label: 'G',    title: 'Gol',                     width: '3.5%' },
    goals_per_90:       { label: 'G90',  title: 'Gol ogni 90 min',        width: '5%'  },
    assists:            { label: 'A',    title: 'Assist',                  width: '3.5%' },
    assists_per_90:     { label: 'A90',  title: 'Assist ogni 90 min',     width: '5%'  },
    shots_total:        { label: 'ST',   title: 'Tiri totali',            width: '3.5%' },
    shots_on:           { label: 'SO',   title: 'Tiri in porta',          width: '3.5%' },
    shot_accuracy_pct:  { label: 'T%',   title: 'Precisione tiri %',      width: '5%'  },
    key_passes:         { label: 'KP',   title: 'Passaggi chiave',        width: '4%'  },
    tackles_total:      { label: 'Tk',   title: 'Contrasti',              width: '4%'  },
    interceptions:      { label: 'In',   title: 'Intercettazioni',        width: '4%'  },
    blocks:             { label: 'Bl',   title: 'Blocchi',                width: '4%'  },
    duels_won_pct:      { label: 'DW%',  title: '% duelli vinti',         width: '5%'  },
    dribbles_success_pct: { label: 'DR%', title: '% dribbling riusciti',  width: '5%'  },
    pass_accuracy:      { label: 'P%',   title: 'Precisione passaggi %',  width: '5%'  },
    rating:             { label: 'Rt',   title: 'Voto medio',             width: '5%'  },
    yellow_cards:       { label: 'Y',    title: 'Ammonizioni',            width: '3.5%' },
    red_cards:          { label: 'R',    title: 'Espulsioni',             width: '3.5%' },
    saves:              { label: 'Sv',   title: 'Parate',                 width: '4%'  },
    goals_conceded:     { label: 'GS',   title: 'Gol subiti',            width: '4%'  },
    save_pct:           { label: 'SV%',  title: '% Parate',              width: '5.5%' },
    clean_sheet_rate:   { label: 'CS%',  title: 'Clean Sheet %',         width: '5.5%' }
  };

  /* Colonne per ruolo (devono corrispondere alle chiavi di ALL_COLS) */
  var ROLE_COLUMNS = {
    Goalkeeper: [
      'api_player_id','name','overall_score','appearances','minutes',
      'save_pct','saves','goals_conceded','clean_sheet_rate',
      'pass_accuracy','rating','yellow_cards','red_cards'
    ],
    Defender: [
      'api_player_id','name','overall_score','appearances','minutes',
      'tackles_total','interceptions','blocks','duels_won_pct',
      'clean_sheet_rate','pass_accuracy','goals','assists','rating',
      'yellow_cards','red_cards'
    ],
    Midfielder: [
      'api_player_id','name','overall_score','appearances','minutes',
      'goals','goals_per_90','assists','assists_per_90',
      'key_passes','tackles_total','duels_won_pct','dribbles_success_pct',
      'pass_accuracy','rating','yellow_cards','red_cards'
    ],
    Attacker: [
      'api_player_id','name','overall_score','appearances','minutes',
      'goals','goals_per_90','assists','assists_per_90',
      'shots_total','shots_on','shot_accuracy_pct',
      'key_passes','dribbles_success_pct','rating','yellow_cards','red_cards'
    ]
  };

  /* Disclaimer per ruolo */
  var ROLE_DISCLAIMERS = {
    Goalkeeper: 'Score basato su: % Parate, Gol Subiti adj., Clean Sheet %, Rigori parati, Pass %, Rating, Minuti',
    Defender: 'Score basato su: Contrasti, Intercettazioni, Blocchi, Duelli %, Clean Sheet %, Pass %, Gol, Rating, Minuti',
    Midfielder: 'Score basato su: Pass chiave, Assist, Pass %, Contrasti, Duelli %, Gol, Rating, Minuti',
    Attacker: 'Score basato su: Gol, Tiri in porta, Assist, Dribbling %, Pass chiave, Pass %, Rating, Minuti'
  };

  /* ---------- Utilità ---------- */

  function setError(msg) {
    detailError.textContent = msg || '';
    detailError.classList.toggle('visible', !!msg);
  }
  function escapeHtml(s) {
    if (s == null) return '';
    var d = document.createElement('div'); d.textContent = s; return d.innerHTML;
  }

  function renderStatRows(stats) {
    if (!stats) return '';
    return '<div class="stat-row"><span class="label">G</span><span>' + (stats.played ?? '—') + '</span></div>' +
      '<div class="stat-row"><span class="label">V-N-S</span><span>' + (stats.wins ?? '—') + '-' + (stats.draws ?? '—') + '-' + (stats.losses ?? '—') + '</span></div>' +
      '<div class="stat-row"><span class="label">GF / GS</span><span>' + (stats.goals_for ?? '—') + ' / ' + (stats.goals_against ?? '—') + '</span></div>' +
      '<div class="stat-row"><span class="label">DR</span><span>' + (stats.goal_diff ?? '—') + '</span></div>' +
      '<div class="stat-row"><span class="label">Pt</span><span>' + (stats.points ?? '—') + '</span></div>' +
      '<div class="stat-row"><span class="label">Media GF</span><span>' + (stats.avg_goals_for != null ? Number(stats.avg_goals_for).toFixed(2) : '—') + '</span></div>' +
      '<div class="stat-row"><span class="label">Media GS</span><span>' + (stats.avg_goals_against != null ? Number(stats.avg_goals_against).toFixed(2) : '—') + '</span></div>';
  }

  var resultLabelMap = { 'W': 'V', 'D': 'N', 'L': 'S' };
  function renderForm(arr) {
    if (!arr || !arr.length) return '<span style="color:#888;">Nessuna partita</span>';
    return arr.map(function(m) {
      var r = m.result || 'D';
      return '<span class="form-badge ' + r + '" title="' + (m.goals_for ?? 0) + '-' + (m.goals_against ?? 0) + '">' + (resultLabelMap[r] || r) + '</span>';
    }).join('');
  }

  /* ---------- Formattatori ---------- */

  function f0(v) { return v == null ? '—' : String(v); }
  function f2(v) { return v == null ? '<span class="v90">—</span>' : '<span class="v90">' + Number(v).toFixed(2) + '</span>'; }
  function fp(v) { return v == null ? '<span class="v90">—</span>' : '<span class="v90">' + Number(v).toFixed(1) + '</span>'; }
  function fsc(v) {
    if (v == null) return '<span class="sc-n">—</span>';
    var c = v >= 65 ? 'sc-h' : v >= 40 ? 'sc-m' : 'sc-l';
    return '<span class="' + c + '">' + Number(v).toFixed(1) + '</span>';
  }
  function frt(v) { return (v == null || v === 0) ? '—' : Number(v).toFixed(2); }

  /* ---------- Grouping + Sorting ---------- */

  function getSearchTerm() { return (playerSearch.value || '').trim().toLowerCase(); }

  function groupPlayers() {
    var q = getSearchTerm();
    var filtered = q
      ? allPlayers.filter(function(p) { return (p.name || '').toLowerCase().indexOf(q) >= 0; })
      : allPlayers;

    var groups = {};
    ROLE_GROUPS.forEach(function(g) { groups[g.key] = []; });

    filtered.forEach(function(p) {
      var pos = p.position || 'Midfielder';
      if (groups[pos]) {
        groups[pos].push(p);
      } else {
        groups['Midfielder'].push(p);
      }
    });

    ROLE_GROUPS.forEach(function(g) {
      var state = sortStates[g.key] || { key: 'overall_score', dir: 'desc' };
      groups[g.key].sort(function(a, b) {
        var va = a[state.key], vb = b[state.key];
        if (va == null && vb == null) return 0;
        if (va == null) return 1;
        if (vb == null) return -1;
        if (typeof va === 'string') { va = va.toLowerCase(); vb = (vb || '').toLowerCase(); }
        if (va < vb) return state.dir === 'asc' ? -1 : 1;
        if (va > vb) return state.dir === 'asc' ? 1 : -1;
        return 0;
      });
    });

    return groups;
  }

  /* ---------- Rendering cella per tipo ---------- */

  var CELL_RENDER = {
    api_player_id: function(p) {
      var pid = p.api_player_id || p.player_id || 0;
      var sn = getCurrentSeason();
      return '<a href="/api/debug/player/' + pid + '/season/' + sn + '" class="player-id-link" title="API ID" onclick="event.stopPropagation()">' + pid + '</a>';
    },
    name: function(p) { return escapeHtml(p.name || '—'); },
    overall_score: function(p) { return fsc(p.overall_score); },
    goals_per_90: function(p) { return f2(p.goals_per_90); },
    assists_per_90: function(p) { return f2(p.assists_per_90); },
    shot_accuracy_pct: function(p) { return fp(p.shot_accuracy_pct); },
    duels_won_pct: function(p) { return fp(p.duels_won_pct); },
    dribbles_success_pct: function(p) { return fp(p.dribbles_success_pct); },
    pass_accuracy: function(p) { return fp(p.pass_accuracy); },
    rating: function(p) { return frt(p.rating); },
    save_pct: function(p) { return fp(p.save_pct); },
    clean_sheet_rate: function(p) { return fp(p.clean_sheet_rate); }
  };

  function renderCell(key, p) {
    if (CELL_RENDER[key]) return CELL_RENDER[key](p);
    return f0(p[key]);
  }

  /* ---------- Costruzione HTML tabella per ruolo ---------- */

  function buildColgroup(cols) {
    return '<colgroup>' + cols.map(function(key) {
      var w = (ALL_COLS[key] && ALL_COLS[key].width) || '5%';
      return '<col style="width:' + w + '">';
    }).join('') + '</colgroup>';
  }

  function buildThead(cols, role) {
    var state = sortStates[role] || { key: 'overall_score', dir: 'desc' };
    var ths = cols.map(function(key) {
      var col = ALL_COLS[key] || {};
      var cls = 'sortable' + (col.cls ? ' ' + col.cls : '');
      if (key === state.key) cls += state.dir === 'asc' ? ' sorted-asc' : ' sorted-desc';
      return '<th class="' + cls + '" data-sort="' + key + '" data-role="' + role + '" title="' + (col.title || key) + '">' + (col.label || key) + '</th>';
    }).join('');
    return '<thead><tr>' + ths + '</tr></thead>';
  }

  function buildPlayerRow(p, cols) {
    var cells = cols.map(function(key) {
      var col = ALL_COLS[key] || {};
      var cellCls = col.cellCls ? ' class="' + col.cellCls + '"' : '';
      return '<td' + cellCls + '>' + renderCell(key, p) + '</td>';
    }).join('');
    return '<tr class="clickable" data-player-id="' + p.player_id + '">' + cells + '</tr>';
  }

  /* ---------- Render principale ---------- */

  function renderPlayersTable() {
    var groups = groupPlayers();
    var html = '';

    ROLE_GROUPS.forEach(function(g) {
      var players = groups[g.key];
      if (!players || !players.length) return;
      var cols = ROLE_COLUMNS[g.key] || ROLE_COLUMNS['Midfielder'];
      var disclaimer = ROLE_DISCLAIMERS[g.key] || '';

      html += '<div class="role-header">' +
        '<span class="role-badge ' + g.css + '">' + g.label + '</span>' +
        '<span class="role-count">' + players.length + ' giocatori</span>' +
        '</div>';
      if (disclaimer) {
        html += '<div class="role-disclaimer">' + disclaimer + '</div>';
      }
      html += '<div class="players-table-wrap">';
      html += '<table class="players-table" aria-label="' + g.label + '">';
      html += buildColgroup(cols);
      html += buildThead(cols, g.key);
      html += '<tbody>';
      players.forEach(function(p) { html += buildPlayerRow(p, cols); });
      html += '</tbody></table></div>';
    });

    playersGroups.innerHTML = html;
    attachSortHandlers();
    attachRowClickHandlers();
  }

  function attachSortHandlers() {
    playersGroups.querySelectorAll('.players-table th.sortable').forEach(function(th) {
      th.addEventListener('click', function() {
        var key = th.getAttribute('data-sort');
        var role = th.getAttribute('data-role');
        var state = sortStates[role] || { key: 'overall_score', dir: 'desc' };
        if (key === state.key) {
          state.dir = state.dir === 'asc' ? 'desc' : 'asc';
        } else {
          state.key = key;
          state.dir = (key === 'name') ? 'asc' : 'desc';
        }
        sortStates[role] = state;
        renderPlayersTable();
      });
    });
  }

  function attachRowClickHandlers() {
    playersGroups.querySelectorAll('tr.clickable').forEach(function(tr) {
      tr.addEventListener('click', function(e) {
        if (e.target.closest('a')) return;
        var id = tr.getAttribute('data-player-id');
        if (id) console.log('Player click (dettaglio futuro):', id);
      });
    });
  }

  /* ---------- Data loading ---------- */

  function loadDetail(season) {
    setError('');
    detailLoading.style.display = 'flex';
    detailContent.classList.remove('visible');
    fetch('/api/teams/' + teamId + '/season/' + season + '/detail')
      .then(function(r) {
        if (!r.ok) throw new Error(r.status === 404 ? 'Squadra non trovata' : 'Errore ' + r.status);
        return r.json();
      })
      .then(function(data) {
        detailLoading.style.display = 'none';
        detailContent.classList.add('visible');
        teamNameEl.textContent = (data.team && data.team.team_name) ? data.team.team_name : '—';
        teamSubEl.textContent = 'Stagione ' + season;
        seasonStatsEl.innerHTML = renderStatRows(data.season_stats);
        homeStatsEl.innerHTML = renderStatRows(data.home_stats);
        awayStatsEl.innerHTML = renderStatRows(data.away_stats);
        formBadgesEl.innerHTML = renderForm(data.form_last5);
        loadPlayers(season);
      })
      .catch(function(e) {
        detailLoading.style.display = 'none';
        setError(e.message || 'Errore di rete.');
      });
  }

  function loadPlayers(season) {
    playersLoading.style.display = 'flex';
    playersEmpty.style.display = 'none';
    playersGroups.style.display = 'none';
    fetch('/api/teams/' + teamId + '/season/' + season + '/players')
      .then(function(r) { return r.ok ? r.json() : []; })
      .then(function(list) {
        allPlayers = list || [];
        playersLoading.style.display = 'none';
        if (allPlayers.length === 0) {
          playersEmpty.style.display = 'block';
        } else {
          playersGroups.style.display = 'block';
          renderPlayersTable();
        }
      })
      .catch(function() {
        playersLoading.style.display = 'none';
        playersEmpty.style.display = 'block';
      });
  }

  /* ---------- Event listeners ---------- */

  seasonSelect.addEventListener('change', function() {
    var s = parseInt(seasonSelect.value, 10);
    if (!isNaN(s)) window.location.href = '/teams/' + teamId + '?season=' + s;
  });

  playerSearch.addEventListener('input', function() {
    if (allPlayers.length) renderPlayersTable();
  });

  function getCurrentSeason() { return parseInt(seasonSelect.value, 10) || initialSeason; }

  /* ---------- Ingestion ---------- */

  function ingestPlayers() {
    var season = getCurrentSeason();
    btnLoadRoster.disabled = true;
    btnLoadRoster.classList.add('loading');
    ingestResult.className = 'ingest-result';
    ingestResult.style.display = 'none';

    fetch('/api/teams/' + teamId + '/season/' + season + '/ingest-players', { method: 'POST' })
      .then(function(r) {
        if (!r.ok) return r.json().then(function(err) { throw new Error(err.detail || 'Errore ' + r.status); });
        return r.json();
      })
      .then(function(data) {
        btnLoadRoster.disabled = false;
        btnLoadRoster.classList.remove('loading');
        ingestResult.className = 'ingest-result success';
        ingestResult.textContent = 'Caricati ' + data.players_ingested + ' giocatori.';
        if (data.players_ingested > 0) {
          setTimeout(function() { loadPlayers(season); }, 600);
        }
      })
      .catch(function(e) {
        btnLoadRoster.disabled = false;
        btnLoadRoster.classList.remove('loading');
        ingestResult.className = 'ingest-result error';
        ingestResult.textContent = 'Errore: ' + (e.message || 'Errore di rete.');
      });
  }

  btnLoadRoster.addEventListener('click', ingestPlayers);

  /* ---------- Init ---------- */

  (function init() {
    fetch('/leagues/seasons').then(function(r) { return r.ok ? r.json() : null; }).then(function(data) {
      var seasons = (data && data.seasons) ? data.seasons : [2024];
      seasonSelect.innerHTML = '';
      seasons.forEach(function(y) {
        var opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y === 2024 ? '2024/2025' : String(y);
        opt.selected = (y === initialSeason);
        seasonSelect.appendChild(opt);
      });
    }).catch(function() {
      seasonSelect.innerHTML = '<option value="2024">2024/2025</option>';
      if (initialSeason !== 2024) seasonSelect.innerHTML = '<option value="' + initialSeason + '">' + initialSeason + '</option>' + seasonSelect.innerHTML;
    });
    loadDetail(initialSeason);
  })();
})();
</script>
{% endblock %}
